name: Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_wheel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      - name: Install dependencies
        run: |
          uv sync --extra dev
      - name: Create wheel
        run: |
          uv build
      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: cyber_query_ai
          path: dist/cyber_query_ai-*-py3-none-any.whl

  build_frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "cyber-query-ai-frontend/package-lock.json"
      - name: Install frontend dependencies
        run: |
          cd cyber-query-ai-frontend
          npm ci
      - name: Build frontend
        run: |
          cd cyber-query-ai-frontend
          npm run build
      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend_build
          path: cyber-query-ai-frontend/out

  create_installer:
    runs-on: ubuntu-latest
    needs: [build_wheel, build_frontend]
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: cyber_query_ai
      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend_build
          path: static
      - name: Prepare release directory
        run: |
          PACKAGE_NAME="cyber_query_ai"
          WHEEL_FILE=$(find . -name "${PACKAGE_NAME}-*-py3-none-any.whl")
          PACKAGE_VERSION=$(echo "$WHEEL_FILE" | sed -n "s/.*${PACKAGE_NAME}-\(.*\)-py3-none-any\.whl/\1/p")

          mv "$WHEEL_FILE" release/
          mv static release/
          chmod +x release/install_cyber_query_ai.sh
          mv release ${PACKAGE_NAME}_${PACKAGE_VERSION}

          tree ${PACKAGE_NAME}_${PACKAGE_VERSION} --dirsfirst -F
      - name: Create release tarball
        run: |
          PACKAGE_NAME="cyber_query_ai"
          WHEEL_FILE=$(find . -name "${PACKAGE_NAME}-*-py3-none-any.whl")
          PACKAGE_VERSION=$(echo "$WHEEL_FILE" | sed -n "s/.*${PACKAGE_NAME}-\(.*\)-py3-none-any\.whl/\1/p")
          tar -czf ${PACKAGE_NAME}_${PACKAGE_VERSION}.tar.gz ${PACKAGE_NAME}_${PACKAGE_VERSION}
      - name: Upload release tarball
        uses: actions/upload-artifact@v4
        with:
          name: cyber_query_ai_release
          path: cyber_query_ai_*.tar.gz
  check_installer:
    runs-on: ubuntu-latest
    needs: create_installer
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      - name: Download artifact from create_installer job
        uses: actions/download-artifact@v4
        with:
          name: cyber_query_ai_release
      - name: Extract release tarball
        run: |
          TAR_FILE=$(find . -name 'cyber_query_ai_*.tar.gz')
          tar -xzf $TAR_FILE
      - name: Run installer script
        run: |
          TAR_FILE=$(find . -name 'cyber_query_ai_*.tar.gz')
          DIR_NAME=$(basename "$TAR_FILE" .tar.gz)
          cd "$DIR_NAME"
          ./install_cyber_query_ai.sh

          echo "$DIR_NAME/"
          tree --dirsfirst -F

          if [ -f "install_cyber_query_ai.sh" ]; then
            echo "Installer script not removed"
            exit 1
          fi

          if [ -f "install_cyber_query_ai.bat" ]; then
            echo "Windows installer script not removed"
            exit 1
          fi

          if [ ! -d ".venv" ]; then
            echo "Virtual environment not found"
            exit 1
          fi

          if [ ! -d "static" ]; then
            echo "Static directory not found"
            exit 1
          fi

          if [ ! -d "service" ]; then
            echo "Service directory not found"
            exit 1
          fi

          if [ ! -f "service/start_service.sh" ]; then
            echo "Executable 'service/start_service.sh' not found"
            exit 1
          fi

          if [ ! -f "service/stop_service.sh" ]; then
            echo "Executable 'service/stop_service.sh' not found"
            exit 1
          fi

          if [ ! -f "config.json" ]; then
            echo "Config file not found"
            exit 1
          fi

          if [ ! -f "README.md" ]; then
            echo "README file not found"
            exit 1
          fi

          if [ ! -f "SECURITY.md" ]; then
            echo "SECURITY file not found"
            exit 1
          fi

          if [ ! -f "LICENSE" ]; then
            echo "LICENSE file not found"
            exit 1
          fi

          if [ ! -f "cyber-query-ai" ]; then
            echo "Executable 'cyber-query-ai' not found"
            exit 1
          fi

          if [ ! -f "uninstall_cyber_query_ai.sh" ]; then
            echo "Uninstallation file not found"
            exit 1
          fi
